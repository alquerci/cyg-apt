cache:
    - '%CYG_CACHE%'

environment:
    global:
        CYG_MIRROR: http://cygwin.uib.no

    matrix:
        -
            CYG_ARCH: x86_64
            CYG_ROOT: C:/cygwin-x64
            CYG_CACHE: 'C:\cygwin-x64\var\cache\setup'
            PYTHON: C:/cygwin-x64/bin/python2.7.exe
            PYTHON_PLATFORM: cygwin

        -
            CYG_ARCH: x86
            CYG_ROOT: C:/cygwin
            CYG_CACHE: 'C:\cygwin\var\cache\setup'
            PYTHON: C:/python27-x64/python.exe
            PYTHON_DIR: 'C:\\python27-x64'
            PYTHON_VERSION: '2.7'

        -
            CYG_ARCH: x86
            CYG_ROOT: C:/cygwin
            CYG_CACHE: 'C:\cygwin\var\cache\setup'
            PYTHON: C:/python27/python.exe
            PYTHON_DIR: 'C:\\python27'
            PYTHON_VERSION: '2.7'
            PYTHON_ARCH: '32'

        -
            CYG_ARCH: x86_64
            CYG_ROOT: C:/cygwin-x64
            CYG_CACHE: 'C:\cygwin-x64\var\cache\setup'
            PYTHON: C:/python27-x64/python.exe
            PYTHON_DIR: 'C:\\python27-x64'
            PYTHON_VERSION: '2.7'

        -
            CYG_ARCH: x86_64
            CYG_ROOT: C:/cygwin-x64
            CYG_CACHE: 'C:\cygwin-x64\var\cache\setup'
            PYTHON: C:/python27/python.exe
            PYTHON_DIR: 'C:\\python27'
            PYTHON_VERSION: '2.7'
            PYTHON_ARCH: '32'

        -
            CYG_ARCH: x86
            CYG_ROOT: C:/cygwin
            CYG_CACHE: 'C:\cygwin\var\cache\setup'
            PYTHON: C:/python26-x64/python.exe
            PYTHON_DIR: 'C:\\python26-x64'
            PYTHON_VERSION: '2.6'

        -
            CYG_ARCH: x86
            CYG_ROOT: C:/cygwin
            CYG_CACHE: 'C:\cygwin\var\cache\setup'
            PYTHON: C:/python26/python.exe
            PYTHON_DIR: 'C:\\python26'
            PYTHON_VERSION: '2.6'
            PYTHON_ARCH: '32'

        -
            CYG_ARCH: x86_64
            CYG_ROOT: C:/cygwin-x64
            CYG_CACHE: 'C:\cygwin-x64\var\cache\setup'
            PYTHON: C:/python26-x64/python.exe
            PYTHON_DIR: 'C:\\python26-x64'
            PYTHON_VERSION: '2.6'

        -
            CYG_ARCH: x86_64
            CYG_ROOT: C:/cygwin-x64
            CYG_CACHE: 'C:\cygwin-x64\var\cache\setup'
            PYTHON: C:/python26/python.exe
            PYTHON_DIR: 'C:\\python26'
            PYTHON_VERSION: '2.6'
            PYTHON_ARCH: '32'

init:
    - 'echo OS architecture: %PROCESSOR_ARCHITECTURE%'

install:
    - 'if not "%PYTHON_PLATFORM%" == "cygwin" dir "C:/python*"'
    - 'if not "%PYTHON_PLATFORM%" == "cygwin" if "%PYTHON_ARCH%" == "" set PYTHON_ARCH=64'
    - 'if not "%PYTHON_PLATFORM%" == "cygwin" if not exist "%PYTHON_DIR%" powershell ./.appveyor/install.ps1'
    - 'appveyor DownloadFile http://cygwin.com/setup-%CYG_ARCH%.exe -FileName setup.exe'
    - 'if not exist %CYG_ROOT%\bin\ setup.exe -qnNdO -R "%CYG_ROOT%" -s "%CYG_MIRROR%" -l "%CYG_CACHE%" -P make -P python -P gnupg > NUL'
    - '%CYG_ROOT%/bin/bash -lc "cygcheck -dc cygwin"'
    - '%PYTHON% --version'
    - '%PYTHON% -c "import sys; print(''Python architecture: {0}''.format(''x64'' if sys.maxsize > 2**32 else ''x86''))"'
    - '%PYTHON% -c "import sys; print(''Python platform: {0}''.format(sys.platform));"'
    - 'if "2.6" == "%PYTHON_VERSION%" appveyor DownloadFile https://raw.githubusercontent.com/bewest/argparse/master/argparse.py -FileName %PYTHON_DIR%/Lib/site-packages/argparse.py'
    - '%CYG_ROOT%/bin/bash -lc "cd \"$OLDPWD\"; cp src/main.py src/cyg-apt.py"'
    - '%CYG_ROOT%/bin/bash -lc "cd \"$OLDPWD\"; make"'
    - '%CYG_ROOT%/bin/bash -lc "cd \"$OLDPWD\"; PYTHONPATH=src python src/cyg-apt.py setup"'
    - '%CYG_ROOT%/bin/bash -lc "cd \"$OLDPWD\"; PYTHONPATH=src python src/cyg-apt.py -f -X install gnupg"'
    - 'git clean -xdf'

build_script:
    - '%CYG_ROOT%/bin/bash -lc "cd \"$OLDPWD\"; make PYTHON=\"$PYTHON\""'

test_script:
    - '%CYG_ROOT%/bin/bash -lc "cd \"$OLDPWD\"; make test PYTHON=\"$PYTHON\""'
    - '%CYG_ROOT%/bin/bash -lc "cd \"$OLDPWD\"; make install"'
    - '%CYG_ROOT%/bin/bash -lc "cd \"$OLDPWD\"; make installtest PYTHON=\"$PYTHON\""'
    - ps: 'cp $env:CYG_ROOT/home/$env:USERNAME/.cyg-apt -destination $env:HOMEPATH'
    - '%PYTHON% %CYG_ROOT%/bin/cyg-apt update -qX'
    - '%PYTHON% %CYG_ROOT%/bin/cyg-apt ball cygwin> ball~'
    - ps: 'Get-Content ball~ | set path; cmd /c $env:CYG_ROOT/bin/cygpath -w $path> ball~'
    - ps: 'Get-Content ball~'
    - ps: 'if (-not(Get-Content ball~ | Test-Path)) { Exit 1 }'
    - 'del ball~'
    # test install on long cwd
    - 'for /L %%X in (0, 1, 45) do (mkdir %%X_d) & (cd %%X_d)'
    - 'cd'
    - '%PYTHON% %CYG_ROOT%/bin/cyg-apt -q install ping'
    - 'cd "%APPVEYOR_BUILD_FOLDER%"'
